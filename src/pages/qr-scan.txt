--- D:\WATATECH\WH\src\pages\qr-scan\QRScanInterfacePage.tsx ---

// Path: src/pages/qr-scan/QRScanInterfacePage.tsx

import React, { useState, useCallback } from "react";
import { toast, Toaster } from "react-hot-toast";
import { ArrowLeft } from "lucide-react";
import type {
  OperationMode,
  InboundScanState,
  OutboundScanState,
  ScannedItem,
  ScannedLocation,
  IssueRequest,
  PickingListItem,
} from "./types";
import {
  fetchScannedData,
  submitPutAwayAction,
  submitIssueAction,
} from "./data";
import Scanner from "./components/Scanner";
// REMOVED: ScanResult không còn dùng cho Inbound
import ActionFeedback from "./components/ActionFeedback";
import ModeSelector from "./components/ModeSelector";
import PickingList from "./components/PickingList";
import IssueQuantityInput from "./components/IssueQuantityInput";
// NEW: Import component mới
import InboundPutAway from "./components/InboundPutAway";

const QRScanInterfacePage: React.FC = () => {
  // State chung
  const [mode, setMode] = useState<OperationMode | "SELECT">("SELECT");
  const [feedback, setFeedback] = useState({ status: "HIDDEN", message: "" });

  // State cho luồng Nhập Kho (Inbound) - Cập nhật lại
  const [inboundState, setInboundState] =
    useState<InboundScanState>("SCANNING_LOCATION");
  const [scannedInboundLocation, setScannedInboundLocation] =
    useState<ScannedLocation | null>(null);
  const [scannedItemsForPutAway, setScannedItemsForPutAway] = useState<
    ScannedItem[]
  >([]);

  // State cho luồng Xuất Kho (Outbound)
  const [outboundState, setOutboundState] =
    useState<OutboundScanState>("SCANNING_REQUEST");
  const [issueRequest, setIssueRequest] = useState<IssueRequest | null>(null);
  const [scannedOutboundItem, setScannedOutboundItem] =
    useState<ScannedItem | null>(null);
  const [currentItemPickingInfo, setCurrentItemPickingInfo] =
    useState<PickingListItem | null>(null);

  const resetInboundState = useCallback(() => {
    setInboundState("SCANNING_LOCATION");
    setScannedInboundLocation(null);
    setScannedItemsForPutAway([]);
  }, []);

  const resetAllStates = useCallback(() => {
    setMode("SELECT");
    setFeedback({ status: "HIDDEN", message: "" });
    // Reset Inbound
    resetInboundState();
    // Reset Outbound
    setOutboundState("SCANNING_REQUEST");
    setIssueRequest(null);
    setScannedOutboundItem(null);
    setCurrentItemPickingInfo(null);
  }, [resetInboundState]);

  const handleError = (error: unknown) => {
    const errorMessage = (error as Error).message;
    toast.error(errorMessage);
    setFeedback({ status: "ERROR", message: errorMessage });
  };

  // --- LOGIC CHO LUỒNG NHẬP KHO (INBOUND) - VIẾT LẠI HOÀN TOÀN ---
  const handleInboundScan = async (qrCode: string) => {
    try {
      const data = await fetchScannedData(qrCode);
      if (inboundState === "SCANNING_LOCATION") {
        if (data.type === "location") {
          setScannedInboundLocation(data as ScannedLocation);
          setInboundState("AWAITING_ITEMS");
          toast.success(`Đã chọn vị trí: ${data.locationCode}`);
        } else {
          toast.error("Vui lòng quét mã VỊ TRÍ KHO trước.");
        }
      } else if (inboundState === "AWAITING_ITEMS") {
        if (data.type === "item") {
          // Kiểm tra xem item đã được quét chưa
          if (
            scannedItemsForPutAway.some((item) => item.qrCode === data.qrCode)
          ) {
            toast.error("Vật tư này đã được quét rồi.");
            return;
          }
          if ((data as ScannedItem).currentLocation) {
            toast.error(
              `Cảnh báo: Vật tư này đã có vị trí (${(
                data as ScannedItem
              ).currentLocation}).`
            );
          }
          setScannedItemsForPutAway((prev) => [...prev, data as ScannedItem]);
          toast.success(`Đã quét vật tư: ${data.sku}`);
        } else {
          toast.error("Vui lòng quét mã VẬT TƯ (cuộn vải, thùng hàng...)." );
        }
      }
    } catch (error) {
      handleError(error);
    }
  };

  const handlePutAwaySubmit = async () => {
    if (!scannedInboundLocation || scannedItemsForPutAway.length === 0) {
      toast.error("Chưa có vật tư nào để cất vào kho.");
      return;
    }
    setInboundState("PROCESSING");
    setFeedback({
      status: "PROCESSING",
      message: "Đang cập nhật vị trí cho các vật tư...",
    });
    try {
      const result = await submitPutAwayAction(
        scannedItemsForPutAway,
        scannedInboundLocation
      );
      setFeedback({
        status: result.success ? "SUCCESS" : "ERROR",
        message: result.message,
      });
    } catch (error) {
      handleError(error);
    }
  };

  // --- LOGIC CHO LUỒNG XUẤT KHO (OUTBOUND) - Không thay đổi ---
  const handleOutboundScan = async (qrCode: string) => {
    try {
      const data = await fetchScannedData(qrCode);
      if (outboundState === "SCANNING_REQUEST") {
        if (data.type === "issue_request") {
          setIssueRequest(data as IssueRequest);
          setOutboundState("REQUEST_LOADED");
          toast.success(`Đã tải phiếu yêu cầu: ${data.id}`);
        } else {
          toast.error("Vui lòng quét mã PHIẾU YÊU CẦU.");
        }
      } else if (outboundState === "SCANNING_ITEM_FOR_ISSUE") {
        if (data.type === "item" && issueRequest) {
          const itemInPickingList = issueRequest.pickingList.find(
            (p) => p.sku === data.sku
          );
          if (itemInPickingList) {
            if (
              itemInPickingList.pickedQuantity >=
              itemInPickingList.requiredQuantity
            ) {
              toast.error(`Đã lấy đủ số lượng cho mã hàng ${data.sku}.`);
              return;
            }
            setScannedOutboundItem(data as ScannedItem);
            setCurrentItemPickingInfo(itemInPickingList);
            setOutboundState("AWAITING_QUANTITY");
          } else {
            toast.error(`Vật tư ${data.sku} không có trong phiếu yêu cầu này!`);
          }
        } else {
          toast.error("Vui lòng quét mã VẬT TƯ.");
        }
      }
    } catch (error) {
      handleError(error);
    }
  };

  const handleIssueSubmit = async (quantity: number) => {
    if (!issueRequest || !scannedOutboundItem) return;
    setOutboundState("PROCESSING_ISSUE");
    setFeedback({ status: "PROCESSING", message: "Đang ghi nhận xuất kho..." });
    try {
      const result = await submitIssueAction(
        issueRequest,
        scannedOutboundItem,
        quantity
      );
      setIssueRequest(result.updatedRequest); // Cập nhật lại request với số lượng mới
      setFeedback({ status: "SUCCESS", message: result.message });
    } catch (error) {
      handleError(error);
    }
  };

  const renderContent = () => {
    if (
      feedback.status === "PROCESSING" ||
      feedback.status === "SUCCESS" ||
      feedback.status === "ERROR"
    ) {
      return (
        <ActionFeedback
          status={feedback.status}
          message={feedback.message}
          onClose={() => {
            // Sau khi xử lý xong, quay lại bước phù hợp
            if (mode === "INBOUND") {
              resetInboundState(); // Quay lại bước quét vị trí
            }
            if (mode === "OUTBOUND") {
              setOutboundState("REQUEST_LOADED"); // Quay lại màn hình picking list
              setScannedOutboundItem(null);
              setCurrentItemPickingInfo(null);
            }
            setFeedback({ status: "HIDDEN", message: "" });
          }}
        />
      );
    }

    if (mode === "SELECT") {
      return <ModeSelector onSelectMode={setMode} />;
    }

    // --- RENDER LUỒNG NHẬP KHO - Cập nhật lại ---
    if (mode === "INBOUND") {
      switch (inboundState) {
        case "SCANNING_LOCATION":
          return (
            <Scanner
              onScan={handleInboundScan}
              scanPrompt="NHẬP KHO: Vui lòng quét mã QR của VỊ TRÍ KHO"
              mode={mode}
            />
          );
        case "AWAITING_ITEMS":
          return (
            scannedInboundLocation && (
              <InboundPutAway
                location={scannedInboundLocation}
                scannedItems={scannedItemsForPutAway}
                onScanItem={handleInboundScan}
                onSubmit={handlePutAwaySubmit}
                onCancel={resetInboundState} // Nút Hủy sẽ reset lại từ đầu
              />
            )
          );
        default:
          return <div>Trạng thái không xác định</div>;
      }
    }

    // --- RENDER LUỒNG XUẤT KHO - Không thay đổi ---
    if (mode === "OUTBOUND") {
      switch (outboundState) {
        case "SCANNING_REQUEST":
          return (
            <Scanner
              onScan={handleOutboundScan}
              scanPrompt="XUẤT KHO: Vui lòng quét mã PHIẾU YÊU CẦU"
              mode={mode}
            />
          );
        case "REQUEST_LOADED":
          return (
            issueRequest && (
              <PickingList
                request={issueRequest}
                onStartScanning={() =>
                  setOutboundState("SCANNING_ITEM_FOR_ISSUE")
                }
                onBack={() => {
                  setOutboundState("SCANNING_REQUEST");
                  setIssueRequest(null);
                }}
              />
            )
          );
        case "SCANNING_ITEM_FOR_ISSUE":
          return (
            <Scanner
              onScan={handleOutboundScan}
              scanPrompt={`Phiếu ${issueRequest?.id}: Quét mã VẬT TƯ cần lấy`}
              mode={mode}
            />
          );
        case "AWAITING_QUANTITY":
          return (
            scannedOutboundItem &&
            currentItemPickingInfo && (
              <IssueQuantityInput
                item={scannedOutboundItem}
                pickingInfo={currentItemPickingInfo}
                onSubmit={handleIssueSubmit}
                onCancel={() => setOutboundState("SCANNING_ITEM_FOR_ISSUE")}
              />
            )
          );
        default:
          return <div>Trạng thái không xác định</div>;
      }
    }
  };

  return (
    <div className="p-4 bg-gray-50 min-h-full">
      <Toaster position="top-center" reverseOrder={false} />
      <div className="container mx-auto">
        {mode !== "SELECT" && (
          <button
            onClick={resetAllStates}
            className="mb-4 flex items-center text-sm font-semibold text-blue-600 hover:text-blue-800"
          >
            <ArrowLeft size={16} className="mr-1" />
            Chọn lại tác vụ
          </button>
        )}
        {renderContent()}
      </div>
    </div>
  );
};

export default QRScanInterfacePage;


--- D:\WATATECH\WH\src\pages\qr-scan\components\ActionFeedback.tsx ---

// Path: src/pages/qr-scan/components/ActionFeedback.tsx

import React from "react";
import { CheckCircle, AlertTriangle, Loader } from "lucide-react";

interface ActionFeedbackProps {
  status: "PROCESSING" | "SUCCESS" | "ERROR";
  message: string;
  onClose: () => void;
}

const ActionFeedback: React.FC<ActionFeedbackProps> = ({ status,
  message,
  onClose,
}) => {
  const renderContent = () => {
    switch (status) {
      case "PROCESSING":
        return (
          <>
            <Loader className="w-16 h-16 text-blue-500 animate-spin mb-4" />
            <h2 className="text-xl font-semibold">Đang xử lý...</h2>
            <p className="text-gray-600">{message}</p>
          </>
        );
      case "SUCCESS":
        return (
          <>
            <CheckCircle className="w-16 h-16 text-green-500 mb-4" />
            <h2 className="text-xl font-semibold">Thành công!</h2>
            <p className="text-gray-600 text-center">{message}</p>
            <button
              onClick={onClose}
              className="mt-6 bg-green-600 text-white font-bold py-2 px-6 rounded-lg"
            >
              Quét Tiếp
            </button>
          </>
        );
      case "ERROR":
        return (
          <>
            <AlertTriangle className="w-16 h-16 text-red-500 mb-4" />
            <h2 className="text-xl font-semibold">Đã xảy ra lỗi!</h2>
            <p className="text-gray-600 text-center">{message}</p>
            <button
              onClick={onClose}
              className="mt-6 bg-red-600 text-white font-bold py-2 px-6 rounded-lg"
            >
              Thử Lại
            </button>
          </>
        );
      default:
        return null;
    }
  };

  return (
    <div className="w-full max-w-md mx-auto p-4 flex flex-col items-center justify-center text-center animate-fade-in">
      <div className="bg-white p-8 rounded-lg shadow-lg w-full flex flex-col items-center">
        {renderContent()}
      </div>
    </div>
  );
};

export default ActionFeedback;


--- D:\WATATECH\WH\src\pages\qr-scan\components\InboundPutAway.tsx ---

// Path: src/pages/qr-scan/components/InboundPutAway.tsx

import React from "react";
import { Check, X, Warehouse } from "lucide-react";
import type { ScannedItem, ScannedLocation } from "../types";
import Scanner from "./Scanner";

interface InboundPutAwayProps {
  location: ScannedLocation;
  scannedItems: ScannedItem[];
  onScanItem: (qrCode: string) => void;
  onSubmit: () => void;
  onCancel: () => void;
}

const InboundPutAway: React.FC<InboundPutAwayProps> = ({ location,
  scannedItems,
  onScanItem,
  onSubmit,
  onCancel,
}) => {
  return (
    <div className="w-full max-w-lg mx-auto p-4 animate-fade-in">
      <div className="bg-white rounded-lg shadow-lg p-6 border border-gray-200">
        <div className="text-center mb-4 border-b pb-4">
          <Warehouse className="mx-auto h-12 w-12 text-blue-500 mb-2" />
          <h2 className="text-xl font-bold text-gray-800">Cất Hàng Vào Kho</h2>
          <p className="text-sm text-gray-500">Vị trí đã chọn:</p>
          <p className="font-mono text-blue-600 bg-blue-100 px-3 py-1 rounded-full inline-block mt-1">
            {location.locationCode}
          </p>
        </div>

        {/* Danh sách các vật tư đã quét */}
        <div className="mb-4">
          <h3 className="font-semibold text-gray-700 mb-2">
            Các vật tư đã quét ({scannedItems.length}):
          </h3>
          <div className="max-h-40 overflow-y-auto space-y-2 pr-2">
            {scannedItems.length === 0 ? (
              <p className="text-center text-gray-500 italic py-4">
                Chưa có vật tư nào được quét.
              </p>
            ) : (
              scannedItems.map((item) => (
                <div
                  key={item.qrCode}
                  className="p-2 bg-gray-50 rounded-md border text-sm"
                >
                  <p className="font-bold text-gray-800">{item.name}</p>
                  <p className="text-xs text-gray-500">SKU: {item.sku}</p>
                </div>
              ))
            )}
          </div>
        </div>

        {/* Khu vực quét */}
        <div className="mt-4">
          <Scanner
            onScan={onScanItem}
            scanPrompt="Tiếp tục quét mã QR trên các cuộn vải/thùng hàng"
            mode="INBOUND"
          />
        </div>
      </div>

      <div className="mt-6 flex space-x-3">
        <button
          onClick={onCancel}
          className="w-1/3 text-lg bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center shadow-md"
        >
          <X className="mr-2" /> Hủy
        </button>
        <button
          onClick={onSubmit}
          disabled={scannedItems.length === 0}
          className="w-2/3 text-lg bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed"
        >
          <Check className="mr-2" /> Hoàn Tất
        </button>
      </div>
    </div>
  );
};

export default InboundPutAway;


--- D:\WATATECH\WH\src\pages\qr-scan\components\IssueQuantityInput.tsx ---

// Path: src/pages/qr-scan/components/IssueQuantityInput.tsx

import React, { useState } from "react";
import type { ScannedItem, PickingListItem } from "../types";
import { Check, X } from "lucide-react";
import { toast } from "react-hot-toast";

interface IssueQuantityInputProps {
  item: ScannedItem;
  pickingInfo: PickingListItem;
  onSubmit: (quantity: number) => void;
  onCancel: () => void;
}

const IssueQuantityInput: React.FC<IssueQuantityInputProps> = ({
  item,
  pickingInfo,
  onSubmit,
  onCancel,
}) => {
  const [quantity, setQuantity] = useState("");

  const remainingNeeded =
    pickingInfo.requiredQuantity - pickingInfo.pickedQuantity;
  const maxCanTake = Math.min(item.quantity, remainingNeeded);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const numQuantity = parseFloat(quantity);
    if (isNaN(numQuantity) || numQuantity <= 0) {
      toast.error("Vui lòng nhập số lượng hợp lệ.");
      return;
    }
    if (numQuantity > maxCanTake) {
      toast.error(`Số lượng không được vượt quá ${maxCanTake} ${item.uom}.`);
      return;
    }
    onSubmit(numQuantity);
  };

  return (
    <div className="w-full max-w-md mx-auto p-4 animate-fade-in">
      <form
        onSubmit={handleSubmit}
        className="bg-white rounded-lg shadow-lg p-6 border border-gray-200"
      >
        <h2 className="text-xl font-bold text-gray-800 mb-2">
          Xác nhận số lượng xuất
        </h2>
        <p className="text-gray-600 mb-4">
          Mặt hàng: <strong>{item.name}</strong>
        </p>

        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-md mb-4 text-sm">
          <p>
            Cần lấy:{" "}
            <strong className="text-red-600">
              {remainingNeeded.toLocaleString()} {pickingInfo.uom}
            </strong>
          </p>
          <p>
            Tồn kho của cuộn/thùng này:{" "}
            <strong>
              {item.quantity.toLocaleString()} {item.uom}
            </strong>
          </p>
          <p className="font-bold mt-1">
            {" "}
            == Tối đa có thể lấy: {maxCanTake.toLocaleString()} {item.uom}
          </p>
        </div>

        <div className="mb-4">
          <label
            htmlFor="quantity"
            className="block text-sm font-medium text-gray-700 mb-1"
          >
            Số lượng thực tế xuất đi ({item.uom})
          </label>
          <input
            type="number"
            id="quantity"
            value={quantity}
            onChange={(e) => setQuantity(e.target.value)}
            className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
            placeholder={`Nhập số ${item.uom.toLowerCase()}...`}
            autoFocus
            step="any"
          />
        </div>

        <div className="flex space-x-3 mt-6">
          <button
            type="button"
            onClick={onCancel}
            className="w-full text-lg bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center shadow-md"
          >
            <X className="mr-2" /> Hủy
          </button>
          <button
            type="submit"
            className="w-full text-lg bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center shadow-md"
          >
            <Check className="mr-2" /> Xác Nhận
          </button>
        </div>
      </form>
    </div>
  );
};

export default IssueQuantityInput;

--- D:\WATATECH\WH\src\pages\qr-scan\components\ModeSelector.tsx ---

// Path: src/pages/qr-scan/components/ModeSelector.tsx

import React from "react";
import { ArrowRight, ArrowLeft } from "lucide-react";
import type { OperationMode } from "../types";

interface ModeSelectorProps {
  onSelectMode: (mode: OperationMode) => void;
}

const ModeSelector: React.FC<ModeSelectorProps> = ({ onSelectMode }) => {
  return (
    <div className="w-full max-w-md mx-auto p-4 flex flex-col items-center justify-center min-h-[70vh]">
      <div className="text-center mb-8">
        <h1 className="text-2xl font-bold text-gray-800">Chọn Tác Vụ</h1>
        <p className="text-gray-600">
          Vui lòng chọn quy trình bạn muốn thực hiện.
        </p>
      </div>
      <div className="w-full space-y-4">
        <button
          onClick={() => onSelectMode("INBOUND")}
          className="w-full text-lg bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-4 rounded-lg flex items-center justify-between shadow-lg transition-transform transform hover:scale-105"
        >
          <span>
            <ArrowRight className="inline-block mr-3" />
            Nhập Kho / Cất Hàng
          </span>
          <span className="text-sm opacity-80">INBOUND</span>
        </button>
        <button
          onClick={() => onSelectMode("OUTBOUND")}
          className="w-full text-lg bg-green-600 hover:bg-green-700 text-white font-bold py-6 px-4 rounded-lg flex items-center justify-between shadow-lg transition-transform transform hover:scale-105"
        >
          <span>
            <ArrowLeft className="inline-block mr-3" />
            Xuất Kho / Soạn Hàng
          </span>
          <span className="text-sm opacity-80">OUTBOUND</span>
        </button>
      </div>
    </div>
  );
};

export default ModeSelector;


--- D:\WATATECH\WH\src\pages\qr-scan\components\PickingList.tsx ---

// Path: src/pages/qr-scan/components/PickingList.tsx

import React from "react";
import type { IssueRequest } from "../types";
import { PackageSearch, ArrowLeft } from "lucide-react";

interface PickingListProps {
  request: IssueRequest;
  onStartScanning: () => void;
  onBack: () => void;
}

const PickingList: React.FC<PickingListProps> = ({
  request,
  onStartScanning,
  onBack,
}) => {
  const isCompleted = request.pickingList.every(
    (item) => item.pickedQuantity >= item.requiredQuantity
  );

  return (
    <div className="w-full max-w-lg mx-auto p-4 animate-fade-in">
      <button
        onClick={onBack}
        className="flex items-center text-gray-600 hover:text-gray-900 font-semibold mb-4"
      >
        <ArrowLeft size={20} className="mr-2" />
        Quay lại
      </button>
      <div className="bg-white rounded-lg shadow-lg p-6 border border-gray-200">
        <div className="text-center mb-4 border-b pb-4">
          <h2 className="text-xl font-bold text-gray-800">
            Phiếu Yêu Cầu Xuất Kho
          </h2>
          <p className="font-mono text-blue-600 bg-blue-100 px-3 py-1 rounded-full inline-block mt-1">
            {request.id}
          </p>
          <p className="text-sm text-gray-500 mt-2">
            Nơi nhận: <strong>{request.destination}</strong>
          </p>
        </div>

        <div className="space-y-4">
          {request.pickingList.map((item) => (
            <div key={item.sku} className="p-3 bg-gray-50 rounded-md border">
              <p className="font-bold text-gray-800">{item.name}</p>
              <p className="text-sm text-gray-500">SKU: {item.sku}</p>
              <div className="mt-2">
                <div className="w-full bg-gray-200 rounded-full h-2.5">
                  <div
                    className="bg-green-500 h-2.5 rounded-full"
                    style={{
                      width: `${Math.min(
                        100,
                        (item.pickedQuantity / item.requiredQuantity) * 100
                      )}%`,
                    }}
                  ></div>
                </div>
                <p className="text-xs text-right mt-1 font-medium">
                  Đã lấy: {item.pickedQuantity.toLocaleString()} /{" "}
                  {item.requiredQuantity.toLocaleString()} {item.uom}
                </p>
              </div>
              <p className="text-xs text-gray-500 mt-1">
                Vị trí gợi ý:{" "}
                <span className="font-mono bg-gray-200 px-1 rounded">
                  {item.locations.join(", ")}
                </span>
              </p>
            </div>
          ))}
        </div>
      </div>

      <div className="mt-6">
        {isCompleted ? (
          <div className="text-center p-4 bg-green-100 text-green-800 rounded-lg">
            <p className="font-bold">Đã hoàn thành phiếu soạn hàng!</p>
          </div>
        ) : (
          <button
            onClick={onStartScanning}
            className="w-full text-lg bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg flex items-center justify-center shadow-md"
          >
            <PackageSearch className="mr-3" /> Bắt Đầu Quét Hàng
          </button>
        )}
      </div>
    </div>
  );
};

export default PickingList;


--- D:\WATATECH\WH\src\pages\qr-scan\components\Scanner.tsx ---

// Path: src/pages/qr-scan/components/Scanner.tsx

import { Camera } from "lucide-react";
import React from "react";
import type { OperationMode } from "../types";

interface ScannerProps {
  onScan: (data: string) => void;
  scanPrompt: string;
  mode: OperationMode | "SELECT";
}

const Scanner: React.FC<ScannerProps> = ({ onScan, scanPrompt, mode }) => {
  const renderDevButtons = () => {
    if (mode === "INBOUND") {
      return (
        <>
          <h3 className="text-sm font-bold text-center text-gray-600">
            GIẢ LẬP NHẬP KHO
          </h3>
          <button
            onClick={() => onScan("ITEM_QR_FAB_001")}
            className="w-full bg-blue-500 text-white py-2 rounded-md"
          >
            Quét Vải (Chưa có vị trí)
          </button>
          <button
            onClick={() => onScan("ITEM_QR_ACC_003")}
            className="w-full bg-blue-500 text-white py-2 rounded-md"
          >
            Quét Phụ Liệu (Đã có vị trí)
          </button>
          <button
            onClick={() => onScan("LOC_QR_A_01_B")}
            className="w-full bg-teal-500 text-white py-2 rounded-md"
          >
            Quét Vị trí Kho Vải
          </button>
        </>
      );
    }
    if (mode === "OUTBOUND") {
      return (
        <>
          <h3 className="text-sm font-bold text-center text-gray-600">
            GIẢ LẬP XUẤT KHO
          </h3>
          <button
            onClick={() => onScan("ISSUE_REQ_001")}
            className="w-full bg-purple-500 text-white py-2 rounded-md"
          >
            Quét Phiếu Yêu Cầu
          </button>
          <button
            onClick={() => onScan("ITEM_QR_FAB_002")}
            className="w-full bg-blue-500 text-white py-2 rounded-md"
          >
            Quét Vải (Có trong phiếu)
          </button>
          <button
            onClick={() => onScan("ITEM_QR_ACC_003")}
            className="w-full bg-blue-500 text-white py-2 rounded-md"
          >
            Quét Phụ Liệu (Có trong phiếu)
          </button>
          <button
            onClick={() => onScan("ITEM_QR_FAB_001")}
            className="w-full bg-orange-500 text-white py-2 rounded-md"
          >
            Quét Vải (KHÔNG có trong phiếu)
          </button>
        </>
      );
    }
    return null;
  };

  return (
    <div className="w-full max-w-md mx-auto p-4 flex flex-col items-center">
      <div className="relative w-full aspect-square bg-gray-900 rounded-lg flex items-center justify-center mb-4 border-4 border-gray-700">
        <Camera className="w-24 h-24 text-gray-600" />
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3/4 h-1/2 border-4 border-dashed border-green-400 rounded-lg"></div>
      </div>

      <p className="text-lg font-semibold text-center text-gray-700 mb-6">
        {scanPrompt}
      </p>

      <div className="w-full space-y-3 p-4 bg-gray-200 rounded-lg border border-gray-300">
        {renderDevButtons()}
        <button
          onClick={() => onScan("QR_INVALID")}
          className="w-full bg-red-500 text-white py-2 rounded-md"
        >
          Quét Mã KHÔNG HỢP LỆ
        </button>
      </div>
    </div>
  );
};

export default Scanner;


--- D:\WATATECH\WH\src\pages\qr-scan\components\ScanResult.tsx ---

// Path: src/pages/qr-scan/components/ScanResult.tsx

import React from "react";
import type { ScannedItem, ScanAction } from "../types";
import { Move, XCircle } from "lucide-react"; // Bỏ CheckSquare

interface ScanResultProps {
  item: ScannedItem;
  onActionSelect: (action: ScanAction) => void;
  onCancel: () => void;
}

const ScanResult: React.FC<ScanResultProps> = ({
  item,
  onActionSelect,
  onCancel,
}) => {
  return (
    <div className="w-full max-w-md mx-auto p-4 animate-fade-in">
      <div className="bg-white rounded-lg shadow-lg p-6 border border-gray-200">
        <h2 className="text-xl font-bold text-gray-800 mb-1">{item.name}</h2>
        <p className="text-sm text-gray-500 mb-4">SKU: {item.sku}</p>

        <div className="space-y-2 text-gray-700">
          <p>
            <strong>Số lượng:</strong> {item.quantity} {item.uom}
          </p>
          <p>
            <strong>Vị trí hiện tại:</strong>
            <span
              className={
                item.currentLocation
                  ? "font-mono bg-gray-200 px-2 py-1 rounded"
                  : "text-gray-400"
              }
            >
              {item.currentLocation || "Chưa có vị trí"}
            </span>
          </p>
          <p>
            <strong>Lô hàng:</strong> {item.shipmentId}
          </p>
        </div>
      </div>

      <div className="mt-6 space-y-3">
        {!item.currentLocation && (
          <button
            onClick={() => onActionSelect("PUT_AWAY")}
            className="w-full text-lg bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg flex items-center justify-center shadow-md"
          >
            <Move className="mr-3" /> Cất Hàng
          </button>
        )}
        {item.currentLocation && (
          <button
            onClick={() => onActionSelect("TRANSFER")}
            className="w-full text-lg bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-lg flex items-center justify-center shadow-md"
          >
            <Move className="mr-3" /> Chuyển Vị Trí
          </button>
        )}
        {/* REMOVED: Nút Kiểm Kê đã bị xóa */}
      </div>

      <div className="mt-8 text-center">
        <button
          onClick={onCancel}
          className="text-red-600 hover:text-red-800 font-semibold flex items-center justify-center mx-auto"
        >
          <XCircle className="mr-2" /> Hủy & Quét Lại
        </button>
      </div>
    </div>
  );
};

export default ScanResult;

--- D:\WATATECH\WH\src\pages\qr-scan\types.ts ---

// Path: src/pages/qr-scan/types.ts
// Path: src/pages/qr-scan/types.ts

// Chế độ hoạt động chính của màn hình
export type OperationMode = 'INBOUND' | 'OUTBOUND';

// --- Types cho luồng Nhập Kho (Inbound) ---
// NEW: Cập nhật trạng thái cho luồng Nhập Kho mới
export type InboundScanState = 'SCANNING_LOCATION' | 'AWAITING_ITEMS' | 'PROCESSING' | 'SUCCESS' | 'ERROR';

// UPDATED: Bỏ 'STOCK_COUNT'
export type ScanAction = 'PUT_AWAY' | 'TRANSFER' | 'VIEW_DETAIL';

// --- Types cho luồng Xuất Kho (Outbound) ---
export type OutboundScanState = 'SCANNING_REQUEST' | 'REQUEST_LOADED' | 'SCANNING_ITEM_FOR_ISSUE' | 'AWAITING_QUANTITY' | 'PROCESSING_ISSUE' | 'ISSUE_SUCCESS' | 'ISSUE_ERROR';

export type PickingListItem = {
  sku: string;
  name: string;
  uom: 'Cây' | 'Thùng' | 'Mét' | 'Cái';
  requiredQuantity: number;
  pickedQuantity: number;
  locations: string[]; // Gợi ý vị trí lấy hàng
};

export type IssueRequest = {
  qrCode: string; // Mã QR của phiếu yêu cầu
  type: 'issue_request';
  id: string;
  destination: string; // Nơi nhận hàng (VD: Bộ phận Cắt)
  status: 'new' | 'in_progress' | 'completed';
  pickingList: PickingListItem[];
};


// --- Types chung ---
export type ScannedItem = {
  qrCode: string;
  type: 'item';
  sku:string;
  name: string;
  quantity: number; // Số lượng gốc của đơn vị này (vd: 150m vải)
  uom: string;
  currentLocation: string | null;
  shipmentId: string; // Thuộc lô hàng nào
};

export type ScannedLocation = {
  qrCode: string;
  type: 'location';
  locationCode: string;
  description: string;
};

// Dữ liệu trả về sau khi quét có thể là 1 trong 3 loại này
export type ScannedData = ScannedItem | ScannedLocation | IssueRequest;


