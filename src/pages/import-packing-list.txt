// src/pages/import-packing-list/ImportPackingListFormPage.tsx

import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import FileUploadZone from "./components/FileUploadZone";
import ActionToolbar from "./components/ActionToolbar";
import type { ShipmentItem } from "./types";

const ImportPackingListFormPage: React.FC = () => {
  const navigate = useNavigate();
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Dữ liệu items sẽ được điền từ file upload
  const [items, setItems] = useState<ShipmentItem[]>([]);

  const handleSubmit = () => {
    console.log("Submitting form:", { items });

    // Validate form before submitting
    if (items.length === 0) {
      alert("Vui lòng tải lên file chứa danh sách hàng hóa.");
      return;
    }

    setIsSubmitting(true);
    setTimeout(() => {
      setIsSubmitting(false);
      // Cập nhật thông báo và điều hướng vì không còn packingListNo
      const newShipmentId = `PNK-${Date.now()}`; // Giả lập ID mới từ server trả về
      alert(`Đã tạo thành công phiếu nhập kho ${newShipmentId}!`);

      // Chuyển hướng đến màn hình chi tiết với ID mới
      navigate(`/shipments/${newShipmentId}`);
    }, 1500);
  };

  return (
    <div className="relative">
      <div className="p-4 md:p-6 space-y-6">
        {/* Header của trang */}
        <div className="flex flex-col md:flex-row justify-between md:items-center">
          <div>
            <h1 className="text-2xl font-bold text-gray-900">
              Nhập Kho Từ File Packing List
            </h1>
            <p className="mt-1 text-sm text-gray-500">
              Tải lên file Excel hoặc CSV để tạo phiếu nhập kho hàng loạt.
            </p>
          </div>
        </div>

        {/* Bỏ hoàn toàn Form Header */}

        {/* Item Details */}
        <div className="bg-white p-6 rounded-lg shadow-md">
          <h2 className="text-xl font-semibold text-gray-800 mb-4">
            Tải lên danh sách hàng hóa
          </h2>
          <div>
            <FileUploadZone onItemsChange={setItems} />
          </div>
        </div>
      </div>

      {/* Action Toolbar */}
      <ActionToolbar onSubmit={handleSubmit} isSubmitting={isSubmitting} />
    </div>
  );
};

export default ImportPackingListFormPage;


// src/pages/import-packing-list/types.ts

// Định nghĩa cho một dòng hàng hóa trong phiếu nhập
export interface ShipmentItem {
  id: string; // ID tạm thời ở client để xử lý key trong list
  sku: string;
  name: string;
  quantity: number;
  uom: string; // Unit of Measure - Đơn vị tính
  batch?: string; // Số lô/batch, không bắt buộc
}

// Định nghĩa cho thông tin chung của phiếu nhập
export interface ShipmentHeader {
  supplier: string;
  poNumber: string;
  packingListNo: string;
  etd: string; // Expected Time of Departure
  eta: string; // Expected Time of Arrival
  notes: string;
}


// src/pages/import-packing-list/components/ActionToolbar.tsx

import React from "react";

interface ActionToolbarProps {
  onSubmit: () => void;
  isSubmitting: boolean;
}

const ActionToolbar: React.FC<ActionToolbarProps> = ({
  onSubmit,
  isSubmitting,
}) => {
  return (
    <div className="sticky bottom-0 bg-white bg-opacity-90 backdrop-blur-sm border-t border-gray-200 p-4 z-10">
      <div className="max-w-7xl mx-auto flex justify-end items-center space-x-4">
        <button
          onClick={onSubmit}
          disabled={isSubmitting}
          className="inline-flex justify-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isSubmitting ? "Đang xử lý..." : "Hoàn tất"}
        </button>
      </div>
    </div>
  );
};

export default ActionToolbar;


// src/pages/import-packing-list/components/FileUploadZone.tsx

import React, { useState, useCallback } from "react";
import { useDropzone } from "react-dropzone";
import { UploadCloud, FileText } from "lucide-react";
import type { ShipmentItem } from "../types";

interface FileUploadZoneProps {
  onItemsChange: (items: ShipmentItem[]) => void;
}

const FileUploadZone: React.FC<FileUploadZoneProps> = ({ onItemsChange }) => {
  const [uploadedFile, setUploadedFile] = useState<File | null>(null);

  const onDrop = useCallback(
    (acceptedFiles: File[]) => {
      if (acceptedFiles.length > 0) {
        setUploadedFile(acceptedFiles[0]);
        // TODO: Xử lý file thật (dùng thư viện như papaparse, xlsx)
        // Ở đây chúng ta chỉ giả lập kết quả sau khi parse file
        console.log("Processing file:", acceptedFiles[0].name);

        // Giả lập dữ liệu sau khi đọc file thành công
        const mockParsedItems: ShipmentItem[] = [
          {
            id: "file-1",
            sku: "FAB-001-RED",
            name: "Vải Kate Đỏ",
            quantity: 1500,
            uom: "M",
            batch: "B001",
          },
          {
            id: "file-2",
            sku: "ACC-012-BLK",
            name: "Nút đen 12mm",
            quantity: 10000,
            uom: "Cái",
          },
          {
            id: "file-3",
            sku: "PCK-003",
            name: "Thùng carton 3 lớp",
            quantity: 250,
            uom: "Thùng",
          },
        ];

        // Cập nhật state ở component cha
        onItemsChange(mockParsedItems);
      }
    },
    [onItemsChange]
  );

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: {
      "text/csv": [".csv"],
      "application/vnd.ms-excel": [".xls"],
      "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": [
        ".xlsx",
      ],
    },
  });

  return (
    <div className="flex flex-col items-center">
      <div
        {...getRootProps()}
        className={`w-full border-2 border-dashed rounded-lg p-12 text-center cursor-pointer transition-colors
          ${
            isDragActive
              ? "border-blue-500 bg-blue-50"
              : "border-gray-300 hover:border-gray-400"
          }`}
      >
        <input {...getInputProps()} />
        <div className="flex flex-col items-center text-gray-500">
          <UploadCloud className="w-12 h-12 mb-4" />
          <p className="font-semibold">
            Kéo thả file vào đây, hoặc nhấn để chọn file
          </p>
          <p className="text-sm">Hỗ trợ các định dạng: CSV, XLS, XLSX</p>
        </div>
      </div>
      {/* <a
        href="/templates/packing-list-template.xlsx"
        download
        className="mt-4 flex items-center text-sm font-medium text-blue-600 hover:underline"
      >
        <Download className="w-4 h-4 mr-1" />
        Tải về file mẫu
      </a> */}
      {uploadedFile && (
        <div className="mt-6 w-full max-w-md bg-gray-100 p-4 rounded-md flex items-center justify-between">
          <div className="flex items-center">
            <FileText className="w-6 h-6 text-gray-600 mr-3" />
            <div>
              <p className="font-medium text-gray-800">{uploadedFile.name}</p>
              <p className="text-sm text-gray-500">
                {(uploadedFile.size / 1024).toFixed(2)} KB
              </p>
            </div>
          </div>
          <p className="text-sm font-semibold text-green-600">
            Đã tải lên và xử lý
          </p>
        </div>
      )}
    </div>
  );
};

export default FileUploadZone;
